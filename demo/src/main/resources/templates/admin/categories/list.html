<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/layout}">

<head>
    <title>Quản lý Danh mục</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="admin-card">
            <div class="card-header">
                <h2 class="card-title">Danh sách Danh mục</h2>
                <a href="/admin/categories/add" class="btn-admin btn-admin-primary">
                    <i class="fa-solid fa-plus"></i> Thêm mới
                </a>
            </div>

            <!-- Search Form -->
            <form method="GET" action="/admin/categories" class="search-form" style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="text" 
                           name="keyword" 
                           th:value="${keyword}"
                           placeholder="Tìm kiếm theo tên danh mục..." 
                           class="admin-input"
                           style="padding-left: 2.5rem;">
                    <i class="fa-solid fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                </div>
                <input type="hidden" name="page" value="0">
                <input type="hidden" name="size" th:value="${pageSize}">
                <button type="submit" class="btn-admin btn-admin-primary">
                    <i class="fa-solid fa-search"></i> Tìm kiếm
                </button>
                <a th:href="@{/admin/categories(page=0, size=${pageSize})}" class="btn-admin btn-admin-edit" th:if="${keyword != null and !keyword.isEmpty()}">
                    <i class="fa-solid fa-times"></i> Xóa bộ lọc
                </a>
            </form>

            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên danh mục</th>
                            <th style="width: 120px; text-align: center;">Số sách</th>
                            <th style="width: 150px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="category : ${categories}">
                            <td>#<span th:text="${category.id}"></span></td>
                            <td>
                                <div style="font-weight: 600;" th:text="${category.name}">Tiểu thuyết</div>
                            </td>
                            <td style="text-align: center;">
                                <span th:if="${bookCountMap != null and bookCountMap.containsKey(category.id) and bookCountMap.get(category.id) > 0}"
                                    th:text="${bookCountMap.get(category.id)}"
                                    style="display: inline-block; padding: 4px 12px; background: #eff6ff; color: #1e40af; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">
                                    0
                                </span>
                                <span th:if="${bookCountMap != null and bookCountMap.containsKey(category.id) and bookCountMap.get(category.id) == 0}"
                                    th:text="${bookCountMap.get(category.id)}"
                                    style="display: inline-block; padding: 4px 12px; background: #fee2e2; color: #991b1b; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">
                                    0
                                </span>
                                <span th:if="${bookCountMap == null or !bookCountMap.containsKey(category.id)}"
                                    style="display: inline-block; padding: 4px 12px; background: #fee2e2; color: #991b1b; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">
                                    0
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <a th:href="@{/admin/categories/edit/{id}(id=${category.id})}"
                                        class="btn-admin btn-admin-edit">
                                        <i class="fa-solid fa-pen"></i> Sửa
                                    </a>
                                    <a th:href="@{/admin/categories/delete/{id}(id=${category.id})}"
                                        class="btn-admin btn-admin-danger"
                                        onclick="return confirm('Bạn có chắc chắn muốn xóa danh mục này?')">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${keyword != null and !keyword.isEmpty() and #lists.isEmpty(categories)}">
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #64748b;">
                                Không tìm thấy danh mục nào với từ khóa "<span th:text="${keyword}"></span>"
                            </td>
                        </tr>
                        <tr th:if="${(keyword == null or keyword.isEmpty()) and #lists.isEmpty(categories)}">
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #64748b;">Chưa có danh mục
                                nào.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" th:if="${totalPages != null}">
                <div class="pagination-info">
                    <span th:if="${keyword != null and !keyword.isEmpty()}">
                        Tìm thấy <span th:text="${totalItems}">0</span> danh mục với từ khóa "<span th:text="${keyword}"></span>"
                    </span>
                    <span th:unless="${keyword != null and !keyword.isEmpty()}">
                        Hiển thị <span th:text="${currentPage * pageSize + 1}">1</span> - 
                        <span th:text="${(currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize}">10</span> 
                        trong tổng số <span th:text="${totalItems}">0</span> danh mục
                    </span>
                </div>
                <ul class="pagination" th:if="${totalPages > 0}">
                    <li class="pagination-item">
                        <a th:href="@{/admin/categories(page=${currentPage - 1}, size=${pageSize}, keyword=${keyword})}" 
                           class="pagination-link"
                           th:classappend="${currentPage == 0} ? 'disabled'"
                           th:if="${currentPage > 0}">
                            <i class="fa-solid fa-chevron-left"></i>
                        </a>
                        <span class="pagination-link disabled" th:if="${currentPage == 0}">
                            <i class="fa-solid fa-chevron-left"></i>
                        </span>
                    </li>
                    <!-- Show pages intelligently -->
                    <th:block th:if="${totalPages <= 7}">
                        <!-- Show all pages if total <= 7 -->
                        <li class="pagination-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                            <a th:href="@{/admin/categories(page=${i}, size=${pageSize}, keyword=${keyword})}" 
                               class="pagination-link"
                               th:classappend="${i == currentPage} ? 'active'"
                               th:text="${i + 1}">1</a>
                        </li>
                    </th:block>
                    <th:block th:if="${totalPages > 7}">
                        <!-- First page -->
                        <li class="pagination-item" th:if="${currentPage > 2}">
                            <a th:href="@{/admin/categories(page=0, size=${pageSize}, keyword=${keyword})}" 
                               class="pagination-link">1</a>
                        </li>
                        <li class="pagination-item" th:if="${currentPage > 3}">
                            <span class="pagination-link disabled">...</span>
                        </li>
                        <!-- Pages around current -->
                        <li class="pagination-item" 
                            th:each="i : ${#numbers.sequence(T(java.lang.Math).max(0, currentPage - 1), T(java.lang.Math).min(totalPages - 1, currentPage + 1))}">
                            <a th:href="@{/admin/categories(page=${i}, size=${pageSize}, keyword=${keyword})}" 
                               class="pagination-link"
                               th:classappend="${i == currentPage} ? 'active'"
                               th:text="${i + 1}">1</a>
                        </li>
                        <!-- Last page -->
                        <li class="pagination-item" th:if="${currentPage < totalPages - 3}">
                            <span class="pagination-link disabled">...</span>
                        </li>
                        <li class="pagination-item" th:if="${currentPage < totalPages - 2}">
                            <a th:href="@{/admin/categories(page=${totalPages - 1}, size=${pageSize}, keyword=${keyword})}" 
                               class="pagination-link" th:text="${totalPages}">1</a>
                        </li>
                    </th:block>
                    <li class="pagination-item">
                        <a th:href="@{/admin/categories(page=${currentPage + 1}, size=${pageSize}, keyword=${keyword})}" 
                           class="pagination-link"
                           th:classappend="${currentPage >= totalPages - 1} ? 'disabled'"
                           th:if="${currentPage < totalPages - 1}">
                            <i class="fa-solid fa-chevron-right"></i>
                        </a>
                        <span class="pagination-link disabled" th:if="${currentPage >= totalPages - 1}">
                            <i class="fa-solid fa-chevron-right"></i>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</body>

</html>